package com.kaer.nfc.demo;

import java.security.PublicKey;

import android.app.Activity;
import android.app.AlertDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.Matrix;
import android.nfc.NfcAdapter;
import android.os.AsyncTask;
import android.os.Bundle;
import android.os.Handler;
import android.os.PowerManager;
import android.os.PowerManager.WakeLock;
import android.util.DisplayMetrics;
import android.view.KeyEvent;
import android.view.View;
import android.widget.ImageView;
import android.widget.ProgressBar;
import android.widget.TextView;

import com.kaer.nfc.sdk.IDCardItem;
import com.kaer.nfc.sdk.LogUtils;
import com.kaer.nfc.sdk.NfcReadClient;
import com.kaer.nfc.sdk.OnClientCallback;

public class IDReaderDemo extends Activity implements OnClientCallback {
	private NfcReadClient mNfcReadClient;
	private TextView message;
	private ImageView photoIv;
	private NfcAdapter mAdapter;
	private long startTime;
	private ProgressBar proBar;
	private TextView proTv;
	private PowerManager pm;
	private WakeLock wl;
	// private int progress;
	private ReadAsync async;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_main);
		initWidget();
		// 必须调用
		mNfcReadClient = NfcReadClient.getInstance();
		mNfcReadClient.init(IDReaderDemo.this);
		mNfcReadClient.setClientCallback(this);

		mAdapter = NfcAdapter.getDefaultAdapter(IDReaderDemo.this);
		if (mAdapter == null) {
			print("手机不支持NFC功能");
		} else if (!mAdapter.isEnabled()) {
			print("手机未打开nfc");
			new AlertDialog.Builder(IDReaderDemo.this)
					.setTitle("是否打开NFC")
					.setPositiveButton("前往",
							new DialogInterface.OnClickListener() {

								@Override
								public void onClick(DialogInterface dialog,
										int which) {
									// TODO Auto-generated method stub
									startActivity(new Intent(
											"android.settings.NFC_SETTINGS"));
								}
							}).setNegativeButton("否", null).create().show();
		}
		pm = (PowerManager) getSystemService(Context.POWER_SERVICE);
		wl = pm.newWakeLock(PowerManager.FULL_WAKE_LOCK, "nfc");
	}

	@Override
	protected void onResume() {
		// TODO Auto-generated method stub
		super.onResume();
		// 必须调用
		mNfcReadClient.enableDispatch();
		if (wl != null && !wl.isHeld())
			wl.acquire();
	}

	private void releaseWakeLock() {
		if (wl != null && wl.isHeld()) {
			wl.release();
			wl = null;
		}
	}

	private void initWidget() {

		message = (TextView) findViewById(R.id.message);
		photoIv = (ImageView) findViewById(R.id.photo);

		proBar = (ProgressBar) findViewById(R.id.probar);
		proBar.setMax(100);
		proTv = (TextView) findViewById(R.id.proTv);
	}

	@Override
	protected void onNewIntent(final Intent intent) {
		// TODO Auto-generated method stub
		super.onNewIntent(intent);
		 mNfcReadClient.readCardWidhIntentAsync(intent);
//		 async = new ReadAsync();
//		 async.execute(intent);
		
	}

	public void print(String string) {
		String msg = message.getText().toString().trim();
		message.setText(msg + "\n" + string);
		LogUtils.d(msg);
	}

	@Override
	protected void onPause() {
		// TODO Auto-generated method stub
		super.onPause();
		mNfcReadClient.disableDispatch();
		releaseWakeLock();
	}

	@Override
	public void readResult(IDCardItem arg0) {
		// TODO Auto-generated method stub
		message.setText(null);
		switch (arg0.retCode) {
		case 1:
			updateView(arg0);
			break;
		case 2:
			clear();
			print("身份证读取过程中移动");
			break;
		case 3:
			clear();
			print("读取过程中网络异常");
			break;
		case 4:
			clear();
			print("服务器连接失败");
			break;
		case 5:
			clear();
			print("读取失败");
			break;
		case 6:
			clear();
			print("标签类型不符合过滤条件");
			break;
		case 7:
			clear();
			print("不支持的证件类型");
			break;
		case 8:
			clear();
			print("读取超时");
			break;
		case -1:
			clear();
			print("重贴标签");

			break;
		default:
			clear();
			break;
		}
		print("读取共耗时:" + String.valueOf(System.currentTimeMillis() - startTime)
				+ "毫秒");

	}

	private void updateView(IDCardItem item) {
		StringBuilder sb = new StringBuilder();
		sb.append("姓名:" + item.partyName + "\n");
		sb.append("性别:" + item.gender + "\n");
		sb.append("民族:" + item.nation + "\n");
		sb.append("出生:" + item.bornDay + "\n");
		sb.append("住址:" + item.certAddress + "\n");
		sb.append("公民身份证号:" + item.certNumber + "\n");
		sb.append("签发机关:" + item.certOrg + "\n");
		String effDate = item.effDate;
		String expDate = item.expDate;
		sb.append("有效期限:" + effDate.substring(0, 4) + "."
				+ effDate.substring(4, 6) + "." + effDate.substring(6, 8) + "-"
				+ expDate.substring(0, 4) + "." + expDate.substring(4, 6) + "."
				+ expDate.substring(6, 8) + "\n");
		print(sb.toString());
		photoIv.setImageBitmap(scale(item.picBitmap));
	}

	private Bitmap scale(Bitmap bitmap) {
		DisplayMetrics displaysMetrics = new DisplayMetrics();
		getWindowManager().getDefaultDisplay().getMetrics(displaysMetrics);
		// TODO Auto-generated constructor stub
		int width = displaysMetrics.widthPixels;
		Matrix matrix = new Matrix();
		float scale = width / (4.0f * bitmap.getWidth());
		matrix.postScale(scale, scale); // 长和宽放大缩小的比例
		Bitmap resizeBmp = Bitmap.createBitmap(bitmap, 0, 0, bitmap.getWidth(),
				bitmap.getHeight(), matrix, true);
		return resizeBmp;
	}

	@Override
	public boolean onKeyDown(int keyCode, KeyEvent event) {
		// TODO Auto-generated method stub
		if (keyCode == KeyEvent.KEYCODE_BACK) {
			if (proBar.getVisibility() == View.VISIBLE) {
				proBar.setVisibility(View.GONE);
				return true;
			}
		}
		return super.onKeyDown(keyCode, event);
	}

	private void clear() {
		proBar.setProgress(0);
		proTv.setText(null);
	}

	@Override
	public void preExcute(long arg0) {
		// TODO Auto-generated method stub
		startTime = arg0;

	}

	@Override
	public void updateProgress(int arg0) {
		// TODO Auto-generated method stub
		proTv.setText(arg0 + " %");
		proBar.setProgress(arg0);
	}

	class ReadAsync extends AsyncTask<Intent, Integer, IDCardItem> {
		@Override
		protected void onPreExecute() {
			// TODO Auto-generated method stub
			super.onPreExecute();
			clear();
			message.setText(null);
			photoIv.setImageBitmap(null);
		}

		@Override
		protected IDCardItem doInBackground(Intent... params) {
			// TODO Auto-generated method stub
			Intent intent = params[0];
			IDCardItem item = mNfcReadClient.readCardWithIntent(intent);
			return item;
		}

		@Override
		protected void onPostExecute(IDCardItem result) {
			// TODO Auto-generated method stub
			super.onPostExecute(result);
			readResult(result);
		}

	}

}
