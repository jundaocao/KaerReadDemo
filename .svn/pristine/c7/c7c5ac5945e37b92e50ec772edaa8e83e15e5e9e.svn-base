package com.kaer.nfc.demo;

import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.List;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.app.PendingIntent;
import android.content.Intent;
import android.content.IntentFilter;
import android.nfc.NfcAdapter;
import android.nfc.Tag;
import android.nfc.tech.NfcB;
import android.os.Bundle;
import android.os.Handler;
import android.text.TextUtils;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.ScrollView;
import android.widget.TextView;

import com.kaer.nfc.sdk.ByteUtils;
import com.kaer.nfc.sdk.ConnectHelper;
import com.kaer.nfc.sdk.ConnectHelper.Connect;
import com.kaer.nfc.sdk.ConnectHelper.OnConnectListener;
import com.kaer.nfc.sdk.IDCardItem;
import com.kaer.nfc.sdk.LogUtils;

public class IDReaderDemo extends Activity implements OnConnectListener,
		OnClickListener {
	private NfcB nfcbTag;
	private int flag;
	public static String IP = "218.56.11.180";
	// 218.56.11.180 192.168.40.147
	public static int PORT = 18320;
	private ConnectHelper tcpHelper;

	private TextView message;
	private ImageView photoIv;
	private EditText ip, port;
	private Button btnConnect, btnDisconnect, btnRead, btnClear;
	private PendingIntent mPendingIntent;
	private String[][] mTechLists;
	private IntentFilter[] mFilters;
	private NfcAdapter mAdapter;
	private static final int UPDATE_MESSAGE = 1;
	private long startTime;
	

	@Override
	public void tcpConnectResult(boolean result) {
		if (result) {
			print("服务器连接成功!");
			changeBtnStatus(false);
		} else {
			print("服务器连接失败!");
		}
	}

	@Override
	public void disconnect(boolean Reconnect) {
		// TODO Auto-generated method stub
		print("与服务器断开连接");
		changeBtnStatus(true);

	}

	private void changeBtnStatus(boolean flag) {
		btnConnect.setVisibility(flag ? View.VISIBLE : View.GONE);
		btnDisconnect.setVisibility(!flag ? View.VISIBLE : View.GONE);

	}

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_main);
		initWidget();
		tcpHelper = ConnectHelper.getInstance();
		tcpHelper.setContext(this);
		tcpHelper.setOnConnectListener(this);
		mAdapter = NfcAdapter.getDefaultAdapter(IDReaderDemo.this);
		mPendingIntent = PendingIntent.getActivity(this, 0, new Intent(this,
				getClass()).addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP), 0);
		IntentFilter tech = new IntentFilter(NfcAdapter.ACTION_TECH_DISCOVERED);
		mFilters = new IntentFilter[] { tech, };
		mTechLists = new String[][] { new String[] { NfcB.class.getName(), }, };
		onNewIntent(getIntent());

	}

	@Override
	protected void onResume() {
		// TODO Auto-generated method stub
		super.onResume();
		if (mAdapter != null)
			mAdapter.enableForegroundDispatch(this, mPendingIntent, mFilters,
					mTechLists);
	}

	private void initWidget() {

		message = (TextView) findViewById(R.id.message);
		photoIv = (ImageView) findViewById(R.id.photo);
		ip = (EditText) findViewById(R.id.ip);
		if (TextUtils.isEmpty(ip.getText())) {
			ip.setText(IP);
		}
		port = (EditText) findViewById(R.id.port);
		port.setText("" + PORT);
		btnConnect = (Button) findViewById(R.id.btnConnect);
		btnDisconnect = (Button) findViewById(R.id.btnDisconnect);
		btnRead = (Button) findViewById(R.id.btnRead);
		btnClear = (Button) findViewById(R.id.btnClear);

		btnConnect.setOnClickListener(this);
		btnDisconnect.setOnClickListener(this);
		btnRead.setOnClickListener(this);
		btnClear.setOnClickListener(this);

	}

	@Override
	protected void onNewIntent(Intent intent) {
		// TODO Auto-generated method stub
		super.onNewIntent(intent);
		if (/*
			 * nfcbTag == null &&
			 */NfcAdapter.ACTION_TECH_DISCOVERED.equals(intent.getAction())) {

			Tag tag = intent.getParcelableExtra(NfcAdapter.EXTRA_TAG);
			String[] arr = tag.getTechList();
			List<String> list = Arrays.asList(arr);
			for (String string : list) {
				System.out.println("支持的技术=" + string);
			}
			if (!list.contains("android.nfc.tech.NfcB")) {
				// 不是NFCB模式的卡
				return;
			}
			nfcbTag = NfcB.get(tag);
			try {
				if (!nfcbTag.isConnected()) {
					nfcbTag.connect();
				}
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			// 开始连接服务器
			print(ByteUtils.formatData(intent
					.getByteArrayExtra(NfcAdapter.EXTRA_ID)));

		}

	}

	private void action() {
		if (ConnectHelper.getInstance().getConnect() == Connect.Disconnect) {

			print("服务器尚未连接...");
			return;
		}

		int code = tcpHelper.readCard(nfcbTag);
		print("开始读取身份证 :" + code);
		if (code == 0) {
			startTime = System.currentTimeMillis();
		}
	}

	public void print(String string) {
		String msg = message.getText().toString().trim();
		message.setText(msg + "\n" + string);
		LogUtils.d(msg);
	}

	@Override
	public void onClick(View v) {
		// TODO Auto-generated method stub
		switch (v.getId()) {
		case R.id.btnClear:
			message.setText(null);
			break;
		case R.id.btnRead:
			message.setText(null);
			photoIv.setImageResource(R.drawable.ic_launcher);
			action();
			break;
		case R.id.btnConnect:
			if (ConnectHelper.getInstance().getConnect() == Connect.Disconnect) {
				print("正在连接服务器...");
				tcpHelper.connect(ip.getText().toString(),
						Integer.parseInt(port.getText().toString()));
			} else {
				print("服务器已连接");
			}
			break;
		case R.id.btnDisconnect:
			if (ConnectHelper.getInstance().getConnect() == Connect.Connected) {
				message.setText(null);
				tcpHelper.disconnect(true);
			}
			break;
		default:
			break;

		}

	}

	@Override
	protected void onPause() {
		// TODO Auto-generated method stub
		super.onPause();
		if (nfcbTag != null && nfcbTag.isConnected()) {
			try {
				nfcbTag.close();
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		if (mAdapter != null)
			mAdapter.disableForegroundDispatch(this);
	}

	@Override
	public void dataResult(IDCardItem arg0) {
		// TODO Auto-generated method stub
		switch (arg0.retCode) {
		case 1:
			tcpHelper.disconnect(true);
			updateView(arg0);
			break;
		case 4:
			tcpHelper.disconnect(true);
			break;
		default:
			break;
		}

		print("读取共耗时:" + String.valueOf(System.currentTimeMillis() - startTime)
				+ "毫秒");

	}

	private void updateView(IDCardItem item) {
		StringBuilder sb = new StringBuilder();
		sb.append("姓名:" + item.name + "\n");
		sb.append("性别:" + (Integer.parseInt(item.gender) == 1 ? "男" : "女")
				+ "\n");
		sb.append("民族:" + item.nation + "\n");
		sb.append("出生:" + item.birth_year + "年" + item.birth_month + "月"
				+ item.birth_day + "日" + "\n");
		sb.append("住址:" + item.address + "\n");
		sb.append("公民身份证号:" + item.certNo + "\n");
		sb.append("签发机关:" + item.certOrg + "\n");
		sb.append("有效期限:" + item.effDate + "-" + item.expDate + "\n");
		print(sb.toString());
		photoIv.setImageBitmap(item.picBitmap);

	}
}
